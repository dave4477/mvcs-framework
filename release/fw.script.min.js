"use strict";var _createClass=function(){function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}}();function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var fw=function(){var e=(_createClass(t,[{key:"loadFiles",value:function(e){var i=this;return new Promise(function(t,n){i._numFiles=e.length,e.forEach(function(e){i.loadFile(e,t,n)})})}},{key:"loadFile",value:function(t,n,e){var i=this,s=new XMLHttpRequest;s.open("GET",t,!0),s.responseType="json",s.onreadystatechange=function(e){e.readyState===XMLHttpRequest.DONE&&(200!==e.status&&i._throwLoadError(t),i._fileLoaded(t,e,n))}.bind(void 0,s),s.send()}},{key:"_fileLoaded",value:function(e,t,n){this._files[e]=t.response,Object.keys(this._files).length===this._numFiles&&(n(this._files),this._files={})}},{key:"_throwLoadError",value:function(e){console.warn("Could not load file with url:",e),this._files[e]=null}}]),t);function t(){_classCallCheck(this,t),this._numFiles=0,this._files={}}var n=Symbol(),i=Symbol(),s={},r={},o={},a=0,u=0,l=(_createClass(c,null,[{key:"subscribe",value:function(e,t){var n=a++;return s[e]||(s[e]={}),s[e][n]=t,{unsubscribe:function(){delete s[e][n],0===Object.keys(s[e]).length&&delete s[e]}}}},{key:"subscribeToView",value:function(e,t){var n=u++;return r[e]||(r[e]={}),r[e][n]=t,{unsubscribe:function(){delete r[e][n],0===Object.keys(r[e]).length&&delete r[e]}}}},{key:"publishToView",value:function(t,n){r[t]&&Object.keys(r[t]).forEach(function(e){return r[t][e](n)})}},{key:"publish",value:function(t,n){if(s[t])if(o.states&&o.states.length&&"switchState"!==t){for(var e=0;e<o.states.length;e++)if(o.states[e].stateName==o.states.current)for(var i=0;i<o.states[e].events.length;i++)o.states[e].events[i]===t&&Object.keys(s[t]).forEach(function(e){return s[t][e](n)})}else Object.keys(s[t]).forEach(function(e){return s[t][e](n)})}},{key:"stateConfig",set:function(e){o.states=e},get:function(){return o}},{key:"instance",get:function(){return this[n]||(this[n]=new c(i)),this[n]}}]),c);function c(e){if(_classCallCheck(this,c),e!==i)throw new Error("Cannot construct singleton")}var h={modelMap:{},controllerMap:{},viewMap:{},serviceMap:{},eventMap:{},addModel:function(e,t){this.modelMap[e]=t},addView:function(e,t){this.viewMap[e]=t},addController:function(e,t){this.controllerMap[e]=t},addService:function(e,t){this.serviceMap[e]=t}},f=(_createClass(v,[{key:"dispatch",value:function(e,t){l.publish(e,t)}},{key:"addListener",value:function(e,t){h.eventMap[e]={},h.eventMap[e][t]=l.subscribe(e,t.bind(this))}},{key:"removeListener",value:function(e,t){h.eventMap[e][t].unsubscribe(),delete h.eventMap[e][t]}},{key:"getModelByName",value:function(e){return h.modelMap[e]}},{key:"getServiceByName",value:function(e){return h.serviceMap[e]}},{key:"getViewByName",value:function(e){return h.viewMap[e]}}]),v);function v(e){_classCallCheck(this,v),h.controllerMap[this.constructor.name]=this}var d=(_createClass(p,[{key:"dispatch",value:function(e,t){l.publish(e,t)}},{key:"getModelByName",value:function(e){return h.modelMap[e]}},{key:"getServiceByName",value:function(){return h.serviceMap[name]}}]),p);function p(e){_classCallCheck(this,p),h.modelMap[e]=this}var y=(_createClass(_,[{key:"getURL",value:async function(e){return this._getURL(e)}},{key:"postURL",value:async function(e,t){return this._postURL(e,t)}},{key:"_getURL",value:async function(t){var n=this,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:5,s=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return await this.httpGet(t).then(function(e){return e},function(e){0<i&&setTimeout(function(){n._getURL(t,--i,++s)},250*s)})}},{key:"_postURL",value:async function(t,n){var i=this,s=2<arguments.length&&void 0!==arguments[2]?arguments[2]:5,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0;return await this.httpPost(t,n).then(function(e){return e},function(e){0<s&&setTimeout(function(){i._postURL(t,n,--s,++r)},150*r)})}},{key:"httpGet",value:async function(e){return new Promise(function(t,n){fetch(e).then(function(e){e.ok?t(e):n()}).catch(function(e){n(e)})})}},{key:"httpPost",value:async function(e,i){return new Promise(function(t,n){fetch(e,{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(i)}).then(function(e){e.ok?t(e):n()}).catch(function(e){n(e)})})}}]),_);function _(){_classCallCheck(this,_)}var k=(_createClass(m,[{key:"dispatch",value:function(e,t){l.publish(e,t)}},{key:"getModelByName",value:function(e){return h.modelMap[e]}},{key:"getServiceByName",value:function(){return h.serviceMap[name]}},{key:"loadView",value:async function(e){return this.backoff.getURL(e)}},{key:"httpGet",value:async function(e){return this.backoff.getURL(e)}},{key:"httpPost",value:async function(e){return this.backoff.postURL(e)}}]),m);function m(e){_classCallCheck(this,m),(h.serviceMap[e]=this).backoff=new y}var g=(_createClass(b,[{key:"addView",value:function(e,t){t=t||document.body;e=e.getElementsByTagName("body")[0].firstChild;return t.appendChild(e),e}},{key:"getViewByName",value:function(e){return h.viewMap[e]}},{key:"dispatchToContext",value:function(e,t){l.publish(e,t)}},{key:"addContextListener",value:function(e,t){this._contextListeners.push({type:e,fn:t}),h.eventMap[e]=h.eventMap[e]||{},h.eventMap[e][t]=l.subscribe(e,t.bind(this))}},{key:"removeContextListener",value:function(e,t){h.eventMap[e][t]?(console.log("removing contextListener:",e),this._removeEvent(this._contextListeners,{type:e,fn:t}),h.eventMap[e][t].unsubscribe(),delete h.eventMap[e][t]):console.warn(this.constructor.name+" Could not unsubsribe  from "+e)}},{key:"dispatchToView",value:function(e,t){l.publishToView(e,t)}},{key:"addViewListener",value:function(e,t){this._viewListeners.push({type:e,fn:t}),h.eventMap[e]=h.eventMap[e]||{},h.eventMap[e][t]=l.subscribeToView(e,t.bind(this))}},{key:"removeViewListener",value:function(e,t){h.eventMap[e][t]?(this._removeEvent(this._viewListeners,{type:e,fn:t}),h.eventMap[e][t].unsubscribe(),delete h.eventMap[e][t]):console.warn(this.constructor.name+" Could not unsubsribe view listener for "+e)}},{key:"removeAllContextListeners",value:function(){var e;console.log("All contextListeners:",this._contextListeners);for(var t=0;t<this._contextListeners.length;t++)e=this._contextListeners[t],this.removeContextListener(e.type,e.fn);this._contextListeners=[]}},{key:"removeAllViewListeners",value:function(){for(var e,t=0;t<this._viewListeners.length;t++)e=this._viewListeners[t],this.removeViewListener(e.type,e.fn);this._viewListeners=[]}},{key:"removeAllListeners",value:function(){this.removeAllContextListeners(),this.removeAllViewListeners()}},{key:"_removeEvent",value:function(e,t){for(var n=0;n<e.length;n++)e[n]==t&&e.splice(n,1)}}]),b);function b(e){_classCallCheck(this,b),(h.viewMap[e]=this)._contextListeners=[],this._viewListeners=[]}var w={stateName:"__system__",preProcess:[],postProcess:[],outbound:[],events:[]},C=(_createClass(x,[{key:"init",value:function(e){this._config=e,this._currentState=w.stateName,e.states.current=this._currentState,w.outbound.push(e.initialState);this._config.states.push(w);l.stateConfig=e.states,this.addListeners(),l.publish("switchState",e.initialState)}},{key:"addListeners",value:function(){var a=this;l.subscribe("switchState",function(e){for(var t=a._config.states,n=t.length,i=0;i<n;i++)if(t[i].stateName==a._currentState){var s=t[i];if(a._currentState){for(var r=0;r<s.outbound.length;r++)if(e===s.outbound[r]){a._processCommands(s.postProcess),a._currentState=e,l.stateConfig.states.current=e,console.log("Switched to state "+a._currentState);var o=a._getNewState(t,e);return a._processCommands(o.preProcess),!0}return console.warn("Could not move to state "+e+" : currentState is "+a._currentState),!1}}})}},{key:"_getNewState",value:function(e,t){for(var n=0;n<e.length;n++)if(e[n].stateName===t)return e[n];return null}},{key:"_processCommands",value:function(e){for(var t=0;t<e.length;t++){var n=e[t].split(":"),i=n[0],n=n[1];h.controllerMap[i][n]()}}}]),x);function x(){_classCallCheck(this,x)}function S(e){_classCallCheck(this,S),this.value=e,this.left=null,this.right=null}var L=(_createClass(M,[{key:"find",value:function(e){if(!this.root)return!1;for(var t=this.root,n=!1;t&&!n;)e<t.value?t=t.left:e>t.value?t=t.right:n=t;return n||void 0}},{key:"insert",value:function(e){var t=new S(e);if(null===this.root)return this.root=t,this;for(var n=this.root;n;){if(e===n.value)return;if(e<n.value){if(null===n.left)return n.left=t,this;n=n.left}else{if(null===n.right)return n.right=t,this;n=n.right}}}},{key:"remove",value:function(e){this.root=this.removeNode(this.root,e)}},{key:"removeNode",value:function(e,t){if(null===e)return e;if(t!==e.value)return t<e.value?e.left=this.removeNode(e.left,t):e.right=this.removeNode(e.right,t),e;if(null===e.left&&null===e.right)return null;if(null===e.left)return e.right;if(null===e.right)return e.left;t=this.smallestNode(e.right);return e.value=t.value,e.right=this.removeNode(e.right,t.value),e}},{key:"smallestNode",value:function(e){for(;null===!e.left;)e=e.left;return e}}]),M);function M(){_classCallCheck(this,M),this.root=null}function R(e){_classCallCheck(this,R),this.data=e,this.next=null,this.prev=null}var N=(_createClass(E,[{key:"append",value:function(e){e=new R(e);this.head?(e.prev=this.tail,this.tail.next=e):this.head=e,this.tail=e}},{key:"appendAt",value:function(e,t){var n=this.head,i=1,s=new R(t);if(0==e)(this.head.prev=s).next=this.head,this.head=s;else for(;n;)n=n.next,i==e&&(s.prev=n.prev,((n.prev.next=s).next=n).prev=s),i++}},{key:"appendAfter",value:function(e){}},{key:"remove",value:function(e){for(var t=this.head;t;)t.data===e&&(t==this.head&&t==this.tail?(this.head=null,this.tail=null):t==this.head?(this.head=this.head.next,this.head.prev=null):t==this.tail?(this.tail=this.tail.prev,this.tail.next=null):(t.prev.next=t.next,t.next.prev=t.prev)),t=t.next}},{key:"removeAt",value:function(e){var t=this.head,n=1;if(0==e)this.head=this.head.next,this.head.prev=null;else for(;t;){if((t=t.next)==this.tail)this.tail=this.tail.prev,this.tail.next=null;else if(n==e){t.prev.next=t.next,t.next.prev=t.prev;break}n++}}},{key:"reverse",value:function(){for(var e=this.head,t=null;e;){var n=e.next;e.next=t,e.prev=n,t=e,e=n}this.tail=this.head,this.head=t}},{key:"swap",value:function(e,t){var n,i,s=this.head,r=0,o=void 0;if(e===t)return console.log("ERROR: 'SWAP' both the nodes must be different!"),!1;if(t<e&&(n=e,e=t,t=n),e<0||t<0)return console.log("ERROR: 'SWAP' both the nodes must be index & index can not be negative!"),!1;for(;null!==s;)r==e?o=s:r==t&&(i=s.data,s.data=o.data,o.data=i),s=s.next,r++;return!0}},{key:"length",value:function(){for(var e=this.head,t=0;null!==e;)t++,e=e.next;return t}},{key:"display",value:function(){for(var e=this.head,t=[];null!==e;)t.push(e.data),e=e.next;return t.join(" ")}},{key:"isEmpty",value:function(){return this.length()<1}},{key:"traverse",value:function(e){if(!e||"function"!=typeof e)return console.log("ERROR: 'TRAVERSE' function is undefined!"),!1;for(var t=this.head;null!==t;)e(t),t=t.next;return!0}},{key:"traverseReverse",value:function(e){if(!e||"function"!=typeof e)return console.log("ERROR: 'TRAVERSE_REVERSE' function is undefined!"),!1;for(var t=this.tail;null!==t;)e(t),t=t.prev;return!0}},{key:"search",value:function(e){for(var t=this.head,n=0;t;){if(t.data==e)return n;t=t.next,n++}return!1}},{key:"getArray",value:function(){for(var e=this.head,t=[];e;)e.data&&t.push(e.data),e=e.next;return t}}]),E);function E(){_classCallCheck(this,E),this.head=null,this.tail=null}var A=(_inherits(V,Array),_createClass(V,[{key:"enqueue",value:function(e){this.push(e)}},{key:"dequeue",value:function(){return this.shift()}},{key:"peek",value:function(){return this[0]}},{key:"isEmpty",value:function(){return 0===this.length}}]),V);function V(){return _classCallCheck(this,V),_possibleConstructorReturn(this,(V.__proto__||Object.getPrototypeOf(V)).call(this))}var O=(_createClass(P,null,[{key:"parseHTML",value:async function(e){e=await e.text();return(new DOMParser).parseFromString(e,"text/html")}},{key:"parseJSON",value:async function(e){return e.json()}}]),P);function P(){_classCallCheck(this,P)}var G=(_createClass(T,[{key:"connectNodes",value:function(e){e.connect(this._mainGain),this._masterGain&&this._mainGain.connect(this._masterGain),this._masterGain.connect(this._context.destination)}},{key:"play",value:function(){var e;this._context&&"suspended"===this._context.state&&this._context.resume(),this._context?((e=this._context.createBufferSource()).buffer=this.sourceNode.buffer,this.sourceNode=e,this.connectNodes(e),e.start()):this.sourceNode.play(),this._isPlaying=!0,console.log("[Sound] playing sound "+this.id)}},{key:"stop",value:function(){this.sourceNode.stop(),this._isPlaying=!1,console.log("[Sound] "+this.id+" was stopped")}},{key:"setVolume",value:function(e){this._mainGain.gain.setValueAtTime(e,0)}},{key:"autoStart",set:function(e){this._autoStart=e}},{key:"masterGain",set:function(e){this._masterGain=e}}]),T);function T(e,t,n){_classCallCheck(this,T),this.id=e,this._autoStart=!0,this._context=n,this._mainGain=n.createGain(),this._masterGain=null,this.sourceNode=n.createBufferSource(),this.sourceNode.buffer=t,this._isPlaying=!1}var j=(_createClass(B,[{key:"playSound",value:function(t){var n=1<arguments.length&&void 0!==arguments[1]&&arguments[1],i=this,s=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,r=!(3<arguments.length&&void 0!==arguments[3])||arguments[3];this._context||(this._context=this.isWebAudioSupported,this._masterGain=this._context.createGain()),this._sounds[t]?(this._sounds[t].loop=n=this._sounds[t].sourceNode.loop=n,this._sounds[t].setVolume(s),this._sounds[t].autoStart=r,this._sounds[t].masterGain=this._masterGain,r&&this._sounds[t].play()):this._loadSounds(t).then(function(e){i.playSound(t,n,s,r)})}},{key:"muteSounds",value:function(){this._masterGain.gain.setValueAtTime(0,0)}},{key:"unmuteSounds",value:function(){this._masterGain.gain.setValueAtTime(1,0)}},{key:"stopSound",value:function(e){this._sounds[e]&&this._sounds[e].stop()}},{key:"getAllSounds",value:function(){return this._sounds}},{key:"setVolume",value:function(e,t){this._sounds[e]&&this._sounds[e].setVolume(t)}},{key:"_loadSounds",value:function(n){var i=this;return new Promise(function(t,e){i.loader.getURL(n).then(function(e){return e.arrayBuffer()}).then(function(e){return i._context.decodeAudioData(e)}).then(function(e){e=new G(n,e,i._context);i._sounds[n]=e,t(i._sounds)})})}},{key:"isWebAudioSupported",get:function(){if(this._context)return this._context;try{return window.AudioContext=window.AudioContext||window.webkitAudioContext,new AudioContext}catch(e){return console.warn("WebAudio is not supported"),null}}}]),B);function B(){_classCallCheck(this,B),this.loader=new y,this._context=null,this._sounds={},this._masterGain=null}return{core:{createStateMachine:function(e){(new C).init(e)},data:{binaryTree:L,linkedList:N,queue:A},parsers:{viewParser:O},connection:{backOff:new y,xhrLoader:new e},controllerCore:f,modelCore:d,serviceCore:k,viewCore:g},utils:{audioManager:new j}}}();